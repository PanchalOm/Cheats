# Getting Started with Terraform for Openstack
Steps:
1. Install terraform
Download terraform binary, extract and copy it to PATH
2. Create a working directory
mkdir terraform-workspace
3. Change to the directory and create working files (resources)
 - You can choose to manage different stuff in different files (for better organization) or use the same one file
 - Terraform reads from .tf files
 - First create a provider .tf file
   vim providers.tf
   # content : In this case for openstack
   terraform {
    required_version = ">= 0.14.0"
     required_providers {
      openstack = {
       source  = "terraform-provider-openstack/openstack"
       version = "~> 1.35.0"
    }
  }
}

4. Initialize terraform
terraform init
# Sample output
Initializing the backend...

Initializing provider plugins...
- Finding terraform-provider-openstack/openstack versions matching "~> 1.35.0"...
- Installing terraform-provider-openstack/openstack v1.35.0...
- Installed terraform-provider-openstack/openstack v1.35.0 (self-signed, key ID 4F80527A391BEFD2)

Partner and community providers are signed by their developers.
If you'd like to know more about provider signing, you can read about it here:
https://www.terraform.io/docs/cli/plugins/signing.html

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.

5. Manage ssh key pair for the cloud VMs accessibility
- Create file main.tf
# content:
resource "openstack_compute_keypair_v2" "my-cloud-key" {
  name       = "my-key"
  public_key = "ssh-rsa AAAAB3Nz..."
}
6. Provide openstack credentials

provider "openstack" {
  user_name = "username"
  password  = "password"
  auth_url  = "http://<IP>/identity"
  user_domain_name = "Default"
  project_domain_name = "Default"
} 
6. Run terraform plan

7. Create an instance resource
resource "openstack_compute_instance_v2" "my_instance" {
  name      = "my_instance"
  image_id  = "0b89b169-0ddb-46df-94cd-748692421574"
  flavor_name = "m1.small"
  key_pair  = "my-key"

  network {
    uuid = "ad3eddbb-fc0f-4450-a427-3f050ea2f0e1"
    name = "public_net"
  }
}

8. run terraform apply


# The Script

terraform {
required_version = ">= 0.14.0"
  required_providers {
    openstack = {
      source  = "terraform-provider-openstack/openstack"
      version = "~> 1.35.0"
    }
  }
}

provider "openstack" {
  user_name = "username"
  password  = "password"
  auth_url  = "http://<ip>/identity"
  user_domain_name = "Default"
  project_domain_name = "Default"
}


resource "openstack_compute_instance_v2" "my_instance" {
  name      = "my_instance"
  image_id  = "0b89b169-0ddb-46df-94cd-748692421574"
  flavor_name = "m1.small"
  key_pair  = "my-key"

  network {
    uuid = "ad3eddbb-fc0f-4450-a427-3f050ea2f0e1"
    name = "public_net"
  }
}

# check vm created, e.g its IP address
terraform show


# What is you want to add more VMs to create a cluster?
# The configuration is similar to the above. we only need to add the configuration for the new VMs
 resource "openstack_compute_instance_v2" "exec" {
  name            = "exec-${count.index}"
  image_name      = "denbi-centos7-j10-2e08aa4bfa33-master"
  flavor_name     = "m1.tiny"
  key_pair        = "${openstack_compute_keypair_v2.my-cloud-key.name}"
  security_groups = ["default"]
  count           = 2

  network {
    name = "public"
  }
}
